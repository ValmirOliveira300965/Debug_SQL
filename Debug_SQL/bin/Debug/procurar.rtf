{\rtf1\ansi\ansicpg1252\deff0{\fonttbl{\f0\fnil\fcharset0 Courier New;}}{\colortbl ;\red255\green0\blue0; \red0\green0\blue255; \red100\green100\blue100; \red0\green128\blue0; \red255\green255\blue0; \red163\green73\blue164; }\viewkind4\uc1\pard\lang1046\f0\fs20\cf2 \cf2  CREATE\cf0 \cf0 \cf2 \cf2  PROC\cf0 \cf0  [dbo].[sp_evMovProd]  \par  @indAcao\cf2 \cf2  CHAR\cf0 \cf0 (1),  \par  @idMov\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0 ,  \par  @idProd\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0 ,  \par  @idProduto\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,  \par  @idOperador\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,  \par  @idVendedor\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,  \par  @idTabPreco\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,  \par   \par  @cProd\cf2 \cf2  NVARCHAR\cf0 \cf0 (60),  \par  @xProd\cf2 \cf2  NVARCHAR\cf0 \cf0 (120),  \par   \par  @vOrig\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10),  \par  @qCom\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (16,4),  \par  @vProd\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2),  \par    \par  @vFrete\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2),  \par  @vDesc\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2),  \par  @vSeg\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2),  \par  @vOutro\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2),  \par   \par  @infAdic\cf2 \cf2  NVARCHAR\cf0 \cf0 (500),  \par   \par  @idUsuario\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,  \par  @idLojaMaster\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,  \par  @ret\cf2 \cf2  NVARCHAR\cf0 \cf0 (4000)\cf2 \cf2  OUTPUT\cf0 \cf0 ,  \par  @retid\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0 \cf2 \cf2  OUTPUT\cf0 \cf0   \par \cf2 \cf2  AS\cf0 \cf0   \par\cf2 \cf2  BEGIN\cf0 \cf0   \par   \par   \cf2 \cf2  DECLARE\cf0 \cf0  @indTransacaoLocal\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  =\cf3 \cf3  NULL\cf0 \cf0   \par   \par   \par   \cf2 \cf2  DECLARE\cf0 \cf0  @alterouFatura\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 0  \par    \cf4--VERIFICA SE EXISTE PARCELAS ( FATURAMENTO ) \cf0  \par   \cf2 \cf2  IF\cf0 \cf0 \cf3 \cf3  EXISTS\cf0 \cf0  \cf2 \cf2 (SELECT\cf0 \cf0  *\cf2 \cf2  FROM\cf0 \cf0  TbMovFaturaProds\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  fat_idProd = @idProd)  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @alterouFatura = 1  \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par    \par      \cf2 \cf2  SET\cf0 \cf0  @ret = \cf1 '' \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par   \par    \cf4--VALIDA USUARIO \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  @idUsuario = 0   \par      \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(0, \cf1 '' \cf0 , 0)  \par       \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par       \cf2 \cf2  RETURN\cf0 \cf0   \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2  BEGIN\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @indAcao = \cf1 'V' \cf0  \cf4-- JA INICIO O PROCESSO VERIFICANDO SE IRA ALTERAR VENDEDOR, POIS A QUERY \'c9 SIMPLES.  \cf0  \par    \cf2 \cf2  BEGIN\cf0 \cf0   \par                \par              \cf4--VERIFICAR PERMISSAO Todos os Produtos em Movimenta\'e7\'f5es Abertas  \cf0  \par            \cf2 \cf2  IF\cf0 \cf0  [dbo].[config_retPermissao] (@idUsuario, @idLojaMaster,500004) <> 1   \par               \cf2 \cf2  THROW\cf0 \cf0  50001, \cf1 'Usu\'e1rio sem permiss\'e3o para alterar o vendedor com a movimenta\'e7\'e3o aberta.' \cf0 , 1;  \par             \cf4--   \cf4--VERIFICAR PERMISSAO Todos os Produtos em Movimenta\'e7\'f5es Finalizadas \cf0 \cf0  \par               \par            \cf2 \cf2  BEGIN\cf0 \cf0   \par            \cf2 \cf2  DECLARE\cf0 \cf0  @indStatus\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0   \par            \cf2 \cf2  SET\cf0 \cf0  @indStatus = \cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 mov_indstatus\cf2 \cf2  FROM\cf0 \cf0  tbmovdados\cf2 \cf2  AS\cf0 \cf0  md\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  md.mov_idMov = @idMov)   \par               \par            \cf2 \cf2  IF\cf0 \cf0  @indStatus = 2\cf3 \cf3  OR\cf0 \cf0  @indStatus = 3  \par            \cf2 \cf2  BEGIN\cf0 \cf0   \par            \cf2 \cf2  IF\cf0 \cf0  [dbo].[config_retPermissao] (@idUsuario, @idLojaMaster,500005) <> 1   \par               \cf2 \cf2  THROW\cf0 \cf0  50001, \cf1 'Usu\'e1rio sem permiss\'e3o para alterar o vendedor com a movimenta\'e7\'e3o finalizada.' \cf0 , 1;  \par             \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par            \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par       \cf2 \cf2  UPDATE\cf0 \cf0  TBMOVPROD\cf2 \cf2  SET\cf0 \cf0  prod_idVendedor = @idVendedor  \cf2 \cf2  WHERE\cf0 \cf0  PROD_IDMOV =  @idMov  \cf3 \cf3  AND\cf0 \cf0  prod_indStatus = 0  \par       \cf2 \cf2  SET\cf0 \cf0  @ret = \cf1 'Vendedor alterado com Sucesso.' \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @retid = NEWID()  \par    \cf2 \cf2  RETURN\cf0 \cf0   \par      \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \cf2  IF\cf0 \cf3 \cf3  ISNULL\cf0 \cf0 (@idTabPreco,0) <= 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @idTabPreco = \cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 cad_idTabPreco\cf2 \cf2  FROM\cf0 \cf0  tbCadastroPagamentos\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  cad_idPagamento = (\cf2  SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 cad_idPagamento\cf2 \cf2  FROM\cf0 \cf0  tbCadastroDados\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  cad_idCadastro = \cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 dest_idCadastro\cf2 \cf2  FROM\cf0 \cf0  tbMovDest\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  dest_idMov = @idMov)))  \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par   \par \cf4--VERIFICAR SE A MOV PODE SOFRER ALTERACAO \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  @idMov\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NULL\cf0 \cf0  Select @idMov = prod_idMov\cf2 \cf2  FROM\cf0 \cf0  tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd  \par         \par   \cf2 \cf2  IF\cf0 \cf0     [dbo].[fc_retMovStatus] (@idMov) <> 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(20, \cf1 '' \cf0 , 0)  \par      \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par      \cf2 \cf2  RETURN\cf0 \cf0   \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par    Declare @tpMov\cf2 \cf2  AS\cf0 \cf0 \cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ,@IdSessao\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0 , @tpNF\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  \cf4--para ser usado na permissao \cf0  \par    Select @tpMov =\cf3 \cf3  ISNULL\cf0 \cf0 (mov_tpMov, 0),@IdSessao = mov_idSessao, @tpNF =\cf3 \cf3  ISNULL\cf0 \cf0 (mov_tpNF,-1)\cf2 \cf2  FROM\cf0 \cf0  tbMovDados\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  mov_idMov = @idMov  \par   \cf2 \cf2  IF\cf0 \cf0  @tpMov = 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O registro n\'e3o foi encontrado.' \cf0 ,0)  \par      \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par      \cf2 \cf2  RETURN\cf0 \cf0   \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \cf2 \cf2  DECLARE\cf0 \cf0  @retPermissao\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0    \par   \cf2 \cf2  DECLARE\cf0 \cf0  @retvPermissao\cf2 \cf2  NVARCHAR\cf0 \cf0 (250)  \par   \par\cf2 \cf2  BEGIN\cf0 \cf0  \cf4-- DELETA e CANCELAR \cf0  \par    \cf4--(D) ACAO DELETAR  \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  @indAcao = \cf1 'D' \cf0    \par    \cf2 \cf2  BEGIN\cf0 \cf0    \par    \cf4--VERIFICAR SE O REGISTRO EXISTE  \cf0  \par     \cf2 \cf2  IF\cf0 \cf0 \cf3  NOT\cf0 \cf3 \cf3  EXISTS\cf0 \cf0 \cf2 \cf2 (SELECT\cf0 \cf0  prod_idMov\cf2 \cf2  FROM\cf0 \cf0  dbo.tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd)  \par      \cf2 \cf2  BEGIN\cf0 \cf0    \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(2, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0    \par      \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par     \cf4--VERIFICAR PERMISSAO  \cf0  \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 10\cf3 \cf3  AND\cf0 \cf0  @tpNF = 0\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5101, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 10\cf3 \cf3  AND\cf0 \cf0  @tpNF = 1\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5001, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 20\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5002, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 30\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5003, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 40\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5005, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 50\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5102, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 60\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5104, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 70\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5007, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 80\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5008, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par     \cf2 \cf2  IF\cf0 \cf0  @retPermissao <> 1   \par      \cf2 \cf2  BEGIN\cf0 \cf0    \par        \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(1, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0    \par      \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par     \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovFaturaPags\cf2 \cf2  WHERE\cf0 \cf0  fat_idFatura\cf3 \cf3  IN\cf0 \cf0  (select fat_idFatura\cf2 \cf2  FROM\cf0 \cf0  TbMovFaturaProds\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  fat_idProd = @idProd)  \par     \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovFaturas\cf2 \cf2  WHERE\cf0 \cf0  fat_idFatura\cf3 \cf3  IN\cf0 \cf0  (select fat_idFatura\cf2 \cf2  FROM\cf0 \cf0  TbMovFaturaProds\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  fat_idProd = @idProd)  \par     \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovProdTransf\cf2 \cf2  WHERE\cf0 \cf0  transf_idProdOrigem = @idProd\cf3 \cf3  AND\cf0 \cf0  transf_tpTransf = 1 \cf4--DELETO PRODUTOS COPIADOS \cf0  \par   \par    \cf4--DELETA O REGISTRO    \cf0  \par     \cf2 \cf2  DECLARE\cf0 \cf0  @xIdNItem\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0   \par   \par     \cf2 \cf2  SELECT\cf0 \cf0  @xIdNItem = PROD_NITEM\cf2 \cf2  FROM\cf0 \cf0  tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par     \cf2 \cf2  WHERE\cf0 \cf0  PROD_IDMOV = @idMov\cf3 \cf3  AND\cf0 \cf0  prod_idProd = @idProd   \par   \par      \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  dbo.tbMovProd\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd   \par     \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(12, \cf1 '' \cf0 , 0)  \par     \cf2 \cf2  IF\cf0 \cf0  @alterouFatura = 1  \par      \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O Registro foi Deletado com Sucesso. /nObs: Os Pagamentos referente \'e0 este Produto foram Deletados. /nNecess\'e1rio refazer o faturamento.' \cf0 , 0)  \par   \par      \cf2 \cf2  SET\cf0 \cf0  @retid = @idProd   \par   \par      \cf4--CALCULA O TOTAL DA MOV \cf0  \par     \cf2 \cf2  EXEC\cf0 \cf0  sp_evMovTotal @idMov  \par   \par     \cf2 \cf2  UPDATE\cf0 \cf0  TBMOVPROD\cf2 \cf2  SET\cf0 \cf0  PROD_NITEM = prod_nItem - 1  \par     \cf2 \cf2  WHERE\cf0 \cf0  PROD_IDMOV = @idMov\cf3 \cf3  AND\cf0 \cf0  PROD_NITEM > @xIdNItem  \par   \par      \cf2 \cf2  RETURN\cf0 \cf0    \par    \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par    \cf4--(C) ACAO CANCELAR  \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  @indAcao = \cf1 'C' \cf0    \par    \cf2 \cf2  BEGIN\cf0 \cf0    \par    \cf4--VERIFICAR SE O REGISTRO EXISTE  \cf0  \par     \cf2 \cf2  IF\cf0 \cf0 \cf3  NOT\cf0 \cf3 \cf3  EXISTS\cf0 \cf0 \cf2 \cf2 (SELECT\cf0 \cf0  prod_idMov\cf2 \cf2  FROM\cf0 \cf0  dbo.tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd)  \par      \cf2 \cf2  BEGIN\cf0 \cf0    \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(2, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0    \par      \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par     \cf4--VERIFICAR PERMISSAO  \cf0  \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 10\cf3 \cf3  AND\cf0 \cf0  @tpNF = 0\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5101, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 10\cf3 \cf3  AND\cf0 \cf0  @tpNF = 1\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5001, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 20\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5002, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 30\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5003, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 40\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5005, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 50\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5102, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 60\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5104, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 70\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5007, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 80\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5008, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par     \cf2 \cf2  IF\cf0 \cf0  @retPermissao <> 1   \par      \cf2 \cf2  BEGIN\cf0 \cf0    \par        \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(1, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0    \par      \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par     \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovFaturaPags\cf2 \cf2  WHERE\cf0 \cf0  fat_idFatura\cf3 \cf3  IN\cf0 \cf0  (select fat_idFatura\cf2 \cf2  FROM\cf0 \cf0  TbMovFaturaProds\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  fat_idProd = @idProd)  \par     \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovFaturas\cf2 \cf2  WHERE\cf0 \cf0  fat_idFatura\cf3 \cf3  IN\cf0 \cf0  (select fat_idFatura\cf2 \cf2  FROM\cf0 \cf0  TbMovFaturaProds\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  fat_idProd = @idProd)  \par   \par       \cf4--DELETA O REGISTRO    \cf0  \par      \cf2 \cf2  UPDATE\cf0 \cf0  dbo.tbMovProd\cf2 \cf2  SET\cf0 \cf0  prod_indStatus = 1\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd   \par     \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 '\'cdtem Cancelado com Sucesso' \cf0 , 0)  \par     \cf2 \cf2  IF\cf0 \cf0  @alterouFatura = 1  \par      \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 '\'cdtem Cancelado com Sucesso. Obs: Os Pagamentos referente \'e0 este Produto foram Deletados' \cf0 , 0)  \par   \par      \cf4--CALCULA O TOTAL DA MOV \cf0  \par     \cf2 \cf2  EXEC\cf0 \cf0  sp_evMovTotal @idMov  \par   \par      \cf2 \cf2  SET\cf0 \cf0  @retid = @idProd   \par      \cf2 \cf2  RETURN\cf0 \cf0    \par    \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par    \cf4--(<> S) - SE NAO   FOR   PARA INSERIR OU SALVAR .. DEVE SAIR.  \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  @indAcao <> \cf1 'S' \cf0    \par     \cf2 \cf2  BEGIN\cf0 \cf0    \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(3, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par         \cf2 \cf2  RETURN\cf0 \cf0    \par     \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0     \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0  \cf4--DELETAR \cf0  \par   \par   \cf2 \cf2  DECLARE\cf0 \cf0  @idLoja\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  \cf4-- ID DA LOJA \cf0  \par   \cf2 \cf2  SET\cf0 \cf0  @idLoja =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 emit_idLoja\cf2 \cf2  FROM\cf0 \cf0  tbMovEmit\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  emit_idMov = @idMov),0)  \par   \par   \par     \cf4--VERIFICAR PERMISSAO  \cf0  \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 10\cf3 \cf3  AND\cf0 \cf0  @tpNF = 0\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5101, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 10\cf3 \cf3  AND\cf0 \cf0  @tpNF = 1\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5001, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 20\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5002, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 30\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5003, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0   \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 40\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5005, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 50\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5102, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 60\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5104, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 70\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5007, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par    \cf2 \cf2  IF\cf0 \cf0  @tpMov = 80\cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 5008, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par     \cf2 \cf2  IF\cf0 \cf0  @retPermissao <> 1   \par      \cf2 \cf2  BEGIN\cf0 \cf0    \par        \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(1, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0    \par      \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \par   \par \cf4/******VALIDA OS CAMPOS PRINCIPAIS*/\cf0 */  \par\cf2 \cf2  BEGIN\cf0 \cf0  \cf4-- VALIDA OS CAMPOS \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  @cProd = \cf1 '' \cf0    \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O c\'f3digo do produto \'e9 obrigat\'f3rio' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par         \cf2 \cf2  RETURN\cf0 \cf0    \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \cf2 \cf2  IF\cf0 \cf0  @xProd = \cf1 '' \cf0    \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O Nome do Produto \'e9 obrigat\'f3rio' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0    \par         \cf2 \cf2  RETURN\cf0 \cf0    \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \cf2 \cf2  IF\cf0 \cf0  @qCom = 0\cf3 \cf3  AND\cf0 \cf0  @tpMov <> 90  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'A quantidade \'e9 obrigat\'f3ria' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0    \par         \cf2 \cf2  RETURN\cf0 \cf0    \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par   \par   \par \cf4/******VERIFICA SE OS REGISTROS EXISTEM*/\cf0 */  \par\cf2 \cf2  BEGIN\cf0 \cf0  \cf4--VALIDA REGISTROS \cf0  \par    \cf4--PRODUTO EXISTE \cf0  \par   \cf2 \cf2  IF\cf0 \cf0 \cf3  NOT\cf0 \cf3 \cf3  EXISTS\cf0 \cf0 \cf2 \cf2 (SELECT\cf0 \cf0  pro_idProduto\cf2 \cf2  FROM\cf0 \cf0  tbProdutoDados\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  pro_idProduto = @idProduto)  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(2, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0          \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par         \par    \cf4--VENDEDOR EXISTE \cf0  \par   \cf2 \cf2  IF\cf0 \cf0 \cf3  NOT\cf0 \cf3 \cf3  EXISTS\cf0 \cf0 \cf2 \cf2 (SELECT\cf0 \cf0  cad_idLogin\cf2 \cf2  FROM\cf0 \cf0  tbCadastroLogins\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  cad_idLogin = @idVendedor)  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(2, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0          \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par    \cf4--OPERADOR EXISTE \cf0  \par   \cf2 \cf2  IF\cf0 \cf0 \cf3  NOT\cf0 \cf3 \cf3  EXISTS\cf0 \cf0 \cf2 \cf2 (SELECT\cf0 \cf0  cad_idLogin\cf2 \cf2  FROM\cf0 \cf0  tbCadastroLogins\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  cad_idLogin = @idOperador)  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(2, \cf1 '' \cf0 , 0)  \par         \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par        \cf2 \cf2  RETURN\cf0 \cf0          \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par\cf2 \cf2  IF\cf0 \cf0  @tpMov = 30  \par\cf2 \cf2  BEGIN\cf0 \cf0   \par      \par    \cf4--VENDEDOR PRINCIPAL (CFG LOJA) \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @cfgLoginPrinc\cf2  AS\cf0 \cf2 \cf2  NVARCHAR\cf0 \cf0 (10)  \par   \cf2 \cf2  SET\cf0 \cf0  @cfgLoginPrinc = \cf2 \cf2 (SELECT\cf0 \cf0  [dbo].[fc_retLojaConfig] (@idLoja,162))  \par      \par      \par   \par    \cf4/*************VERIFICAR PERMISSOES ***********************/\cf0 */  \par   \cf2 \cf2  IF\cf0 \cf0  \cf6 \cf6 (CAST\cf0 \cf0 (@cfgLoginPrinc\cf2  AS\cf0 \cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 ) = 2)  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  IF\cf0 \cf0 \cf3 \cf3  EXISTS\cf0 \cf0  \cf2 \cf2 (SELECT\cf0 \cf0  cad_idLogin\cf2 \cf2  FROM\cf0 \cf0  tbCadastroLogins lg\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                        \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbCadastroDados cd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  lg.cad_idCadastro = cd.cad_idCadastro  \par                        \cf2 \cf2  WHERE\cf0 \cf0  lg.cad_idCadastro = (  \par                           \cf2 \cf2  SELECT\cf0 \cf0  cad_idRepresentante\cf2 \cf2  FROM\cf0 \cf0  tbCadastroDados cr\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                           \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbMovDest md\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  md.dest_idCadastro = cr.cad_idCadastro\cf3 \cf3  AND\cf0 \cf0  md.dest_idMov = @idMov))  \par      \cf2 \cf2  BEGIN\cf0 \cf0   \par         \cf2 \cf2  IF\cf0 \cf0  @idVendedor\cf3  NOT\cf0 \cf3 \cf3  IN\cf0 \cf0  (  \par            \cf2 \cf2  SELECT\cf0 \cf0  cad_idLogin\cf2 \cf2  FROM\cf0 \cf0  tbCadastroLogins lg\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                        \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbCadastroDados cd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  lg.cad_idCadastro = cd.cad_idCadastro  \par                        \cf2 \cf2  WHERE\cf0 \cf0  lg.cad_idCadastro = (  \par                           \cf2 \cf2  SELECT\cf0 \cf0  cad_idRepresentante\cf2 \cf2  FROM\cf0 \cf0  tbCadastroDados cr\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                           \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbMovDest md\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  md.dest_idCadastro = cr.cad_idCadastro\cf3 \cf3  AND\cf0 \cf0  md.dest_idMov = @idMov))  \par         \cf2 \cf2  BEGIN\cf0 \cf0   \par            \cf2 \cf2  SET\cf0 \cf0  @idVendedor = \cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 cad_idLogin\cf2 \cf2  FROM\cf0 \cf0  tbCadastroLogins lg\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                                 \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbCadastroDados cd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  lg.cad_idCadastro = cd.cad_idCadastro  \par                                 \cf2 \cf2  WHERE\cf0 \cf0  lg.cad_idCadastro = (  \par                                    \cf2 \cf2  SELECT\cf0 \cf0  cad_idRepresentante\cf2 \cf2  FROM\cf0 \cf0  tbCadastroDados cr\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                                    \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbMovDest md\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  md.dest_idCadastro = cr.cad_idCadastro\cf3 \cf3  AND\cf0 \cf0  md.dest_idMov = @idMov)),0)  \par         \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par      \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \cf2 \cf2  ELSE\cf0 \cf0   \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  EXECUTE\cf0 \cf0  @retPermissao = [dbo].[sp_cfgRetPermissao] @idUsuario, @idLojaMaster, 500304, @retvPermissao\cf2 \cf2  OUTPUT\cf0 \cf0    \par       \cf2 \cf2  IF\cf0 \cf0  @retPermissao <> 1   \par       \cf2 \cf2  BEGIN\cf0 \cf0    \par         \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O Usu\'e1rio n\'e3o tem permiss\'e3o para Alterar o Vendedor' \cf0 , 0)  \par          \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par          \cf2 \cf2  RETURN\cf0 \cf0    \par       \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0    \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par   \par \cf4/********VALIDAR CAMPOS DOS IMPOSTOS *****************/\cf0 */  \par\cf2 \cf2  BEGIN\cf0 \cf0  \cf4--IMPOSTOS  \cf0  \par      \par   \cf2 \cf2  DECLARE\cf0 \cf0  @idRegCadastro\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 0 \cf4--REGIME DO DESTINATARIO \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @idRegProduto\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 0 \cf4--REGIME DO PRODUTO \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @idNatOp\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 0 \cf4--NATUREZA DA OPERACAO \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @idCFOP\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 0 \cf4-- ID DO CFOP \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @CFOP\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 0 \cf4--CFOP \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @cBenef\cf2 \cf2  NVARCHAR\cf0 \cf0 (10) = \cf1 '' \cf0  \cf4--CBENEF \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @indTot\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0  = 1 \cf4--CFOP \cf0  \par   \par   \cf2 \cf2  SET\cf0 \cf0  @idRegCadastro =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 cad_idRegCadastro  \par                     \cf2 \cf2  FROM\cf0 \cf0  tbCadastroDados\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                     \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbMovDest\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  tbCadastroDados.cad_idCadastro = tbMovDest.dest_idCadastro  \par                     \cf2 \cf2  WHERE\cf0 \cf0  dest_idMov = @idMov),0)  \par   \par   \cf2 \cf2  SET\cf0 \cf0  @idRegProduto =\cf3 \cf3  ISNULL\cf0 \cf0 ((select\cf2 \cf2  TOP\cf0 \cf0  1 pro_idRegProduto  \par                     \cf2 \cf2  FROM\cf0 \cf0  tbProdutoDados\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                     \cf2 \cf2  WHERE\cf0 \cf0  pro_idProduto = @idProduto),0)  \par   \par   \cf2 \cf2  SET\cf0 \cf0  @idNatOp =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 mov_idNatOp\cf2 \cf2  FROM\cf0 \cf0  tbMovDados\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  mov_idMov = @idMov), 0)  \par       \par    \cf4--PEGA O CFOP POR PREFERENCIA DO PRODUTO                            \cf0  \par   \cf2  SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1   \par          @CFOP =\cf3 \cf3  ISNULL\cf0 \cf0 (cfg_cfop, 0),   \par          @idCFOP =\cf3 \cf3  ISNULL\cf0 \cf0 (cfg_idCfop,0),   \par          @indTot =\cf3 \cf3  ISNULL\cf0 \cf0 (cfg_indTot,1),  \par          @cBenef =\cf3 \cf3  ISNULL\cf0 \cf0 (pro_cBenef,\cf1 '' \cf0 )  \par                     \cf2 \cf2  FROM\cf0 \cf0  tbProdutoIcms\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                     \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbConfigCfops \cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                     \cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  tbProdutoIcms.pro_idCfop = tbConfigCfops.cfg_idCfop  \par                     \cf2 \cf2  WHERE\cf0 \cf0    \par                         pro_idRegCadastro = @idRegCadastro  \par                     \cf3 \cf3  AND\cf0 \cf0  pro_idRegProduto\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NULL\cf0 \cf0   \par                     \cf3 \cf3  AND\cf0 \cf0  pro_idProduto = @idProduto  \par                     \cf3 \cf3  AND\cf0 \cf0  pro_idNatOp = @idNatOp  \par                     \cf3 \cf3  AND\cf0 \cf0  pro_idLoja = @idLoja  \par   \cf2  IF\cf0 \cf3 \cf3  ISNULL\cf0 \cf0 (@idCFOP,0) = 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par       \cf4--PEGA O CFOP PELO GRUPO SE NAO ACHOU                               \cf0  \par      \cf2  SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1   \par             @CFOP =\cf3 \cf3  ISNULL\cf0 \cf0 (cfg_cfop, 0),   \par             @idCFOP =\cf3 \cf3  ISNULL\cf0 \cf0 (cfg_idCfop,0),   \par             @indTot =\cf3 \cf3  ISNULL\cf0 \cf0 (cfg_indTot,1),  \par             @cBenef =\cf3 \cf3  ISNULL\cf0 \cf0 (pro_cBenef,\cf1 '' \cf0 )  \par                        \cf2 \cf2  FROM\cf0 \cf0  tbProdutoIcms\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                        \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbConfigCfops \cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par                        \cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  tbProdutoIcms.pro_idCfop = tbConfigCfops.cfg_idCfop  \par                        \cf2 \cf2  WHERE\cf0 \cf0    \par                            pro_idRegCadastro = @idRegCadastro  \par                        \cf3 \cf3  AND\cf0 \cf0  pro_idRegProduto = @idRegProduto  \par                        \cf3 \cf3  AND\cf0 \cf0  pro_idNatOp = @idNatOp  \par                        \cf3 \cf3  AND\cf0 \cf0  pro_idLoja = @idLoja  \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par                        \par \cf4/********** SE ALGUM CAMPO FICAR VAZIO NAO PROSSEGUIR ****/\cf0 */  \par   \cf2 \cf2  IF\cf0 \cf0  @idLoja = 0\cf3 \cf3  OR\cf0 \cf0  @idRegCadastro = 0\cf3 \cf3  OR\cf0 \cf0  @idRegProduto = 0\cf3 \cf3  OR\cf0 \cf0  @idNatOp = 0\cf3 \cf3  OR\cf0 \cf0  @CFOP = 0\cf3  OR\cf0 \cf3 \cf3  ISNULL\cf0 \cf0 (@idCFOP,0) = 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par          \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'Os impostos n\'e3o est\'e3o cadastrados corretamente' \cf0 , 0)  \par          \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0    \par          \cf2 \cf2  RETURN\cf0 \cf0    \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par \cf4\cf4--VALOR MAXIMO (CFG LOJA) \cf0 \cf4--ALTERADO PAR O VALOR TOTAL \cf0 \cf0  \par\cf2 \cf2  DECLARE\cf0 \cf0  @cfgVProdMax\cf2  AS\cf0 \cf2 \cf2  NVARCHAR\cf0 \cf0 (10)  \par\cf2 \cf2  SET\cf0 \cf0  @cfgVProdMax = \cf2 \cf2 (SELECT\cf0 \cf0  [dbo].[fc_retLojaConfig] (@idLoja,124))  \par   \par \cf4--VALOR MAXIMO (CFG LOJA) \cf0  \par\cf2 \cf2  DECLARE\cf0 \cf0  @cfgQComMax\cf2  AS\cf0 \cf2 \cf2  NVARCHAR\cf0 \cf0 (10)  \par\cf2 \cf2  SET\cf0 \cf0  @cfgQComMax = \cf2 \cf2 (SELECT\cf0 \cf0  [dbo].[fc_retLojaConfig] (@idLoja,125))  \par   \par \cf4--ID NATOP PADRAO (CFG LOJA) \cf0  \par\cf2 \cf2  DECLARE\cf0 \cf0  @cfgNatOpPadrao\cf2  AS\cf0 \cf2 \cf2  NVARCHAR\cf0 \cf0 (10)  \par\cf2 \cf2  SET\cf0 \cf0  @cfgNatOpPadrao = \cf2 \cf2 (SELECT\cf0 \cf0  [dbo].[fc_retLojaConfig] (@idLoja,222))  \par   \par \cf4\cf4--VALOR MAXIMO (CFG LOJA) \cf0 \cf4--ALTERADO PAR O VALOR TOTAL \cf0 \cf0  \par\cf2 \cf2  DECLARE\cf0 \cf0  @cfgCasasValor\cf2 \cf2  AS\cf0 \cf0 \cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0   \par\cf2 \cf2  SET\cf0 \cf0  @cfgCasasValor =\cf6 \cf6  CAST\cf0 \cf0 (\cf2 \cf2 (SELECT\cf0 \cf0  [dbo].[fc_retLojaConfig] (@idLoja,101))\cf2  AS\cf0 \cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 )  \par   \par   \par\cf2 \cf2  IF\cf0 \cf0  @vProd >\cf6 \cf6  CAST\cf0 \cf0 (@cfgVProdMax\cf2  AS\cf0 \cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,4))\cf3 \cf3  AND\cf0 \cf0   @tpMov\cf3  NOT\cf0 \cf3 \cf3  IN\cf0 \cf0 (90)   \par\cf2 \cf2  BEGIN\cf0 \cf0   \par   \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O valor total do produto excede a configura\'e7\'e3o na empresa' \cf0 , 0)  \par   \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0    \par   \cf2 \cf2  RETURN\cf0 \cf0    \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2  IF\cf0 \cf0  @qCom >\cf6 \cf6  CAST\cf0 \cf0 (@cfgQComMax\cf2  AS\cf0 \cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,4))\cf3 \cf3  AND\cf0 \cf0   @tpMov\cf3  NOT\cf0 \cf3 \cf3  IN\cf0 \cf0 (90)   \par\cf2 \cf2  BEGIN\cf0 \cf0   \par   \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'A Quantidade M\'e1xima excede a Configura\'e7\'e3o da Empresa' \cf0 , 0)  \par   \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0    \par   \cf2 \cf2  RETURN\cf0 \cf0    \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2  IF\cf0 \cf0  @idNatop =\cf6 \cf6  CAST\cf0 \cf0 (@cfgNatOpPadrao\cf2  AS\cf0 \cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0 )\cf3 \cf3  AND\cf0 \cf0  @tpMov\cf3  NOT\cf0 \cf3 \cf3  IN\cf0 \cf0  (50,60,90)  \par\cf2 \cf2  BEGIN\cf0 \cf0   \par    \cf4--VALIDACAO DE VALOR MINIMO \cf0  \par   \cf2 \cf2  DECLARE\cf0 \cf0  @vMin\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10)  \par   \cf2 \cf2  SET\cf0 \cf0  @vMin =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 pro_vMinimo\cf2 \cf2  FROM\cf0 \cf0  tbProdutoLojas\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  pro_idProduto = @idProduto\cf3 \cf3  AND\cf0 \cf0  pro_idLoja = @idLoja),0)  \par   \cf2 \cf2  IF\cf0 \cf0  ((@vProd - @vDesc) / @qCom) < @vMin\cf3 \cf3  AND\cf0 \cf0  @vMin > 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(99, \cf1 'O Valor Unit\'e1rio \'e9 Menor do que o Configurado para esta Empresa' \cf0 , 0)  \par      \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0    \par      \cf2 \cf2  RETURN\cf0 \cf0    \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2  BEGIN\cf0 \cf0 \cf2 \cf2  TRY\cf0 \cf0   \par   \par\cf2 \cf2  IF\cf0 \cf0 \cf6 \cf6  @@TRANCOUNT\cf0 \cf0  > 0 \cf4--SE J\'c1 INICIOU UMA TRANSA\'c7\'c3O N\'c3O ABRE UMA NOVA \cf0  \par   \cf2 \cf2  SET\cf0 \cf0  @indTransacaoLocal = 0  \par\cf2 \cf2  ELSE\cf0 \cf0   \par\cf2 \cf2  BEGIN\cf0 \cf0   \par   \cf2 \cf2  SET\cf0 \cf0  @indTransacaoLocal = 1  \par   \cf2 \cf2  BEGIN\cf0 \cf0 \cf2 \cf2  TRAN\cf0 \cf0  \cf4-- INICIA A TRANSACAO VAI TRABALHAR COM MAIS Q UMA TABELA \cf0  \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0      \par   \par\cf2 \cf2  DECLARE\cf0 \cf0  @xped\cf2 \cf2  AS\cf0 \cf0  bigint  \par\cf2 \cf2  SET\cf0 \cf0  @xped =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 com_xPed\cf2 \cf2  FROM\cf0 \cf0  tbMovDadosCompra\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  com_idMov = @idMov),0)  \par   \par\cf2 \cf2  DECLARE\cf0 \cf0  @nitemped\cf2 \cf2  AS\cf0 \cf0 \cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0   \par\cf2 \cf2  SET\cf0 \cf0  @nitemped = 0  \par   \par\cf2 \cf2  IF\cf0 \cf0  @idProd\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NOT\cf0 \cf0 \cf3  NULL\cf0 \cf3 \cf3  AND\cf0 \cf0  @xped > 0  \par\cf2 \cf2  BEGIN\cf0 \cf0   \par   \cf2 \cf2  SET\cf0 \cf0  @nitemped =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 \highlight5\fs24\b prod_nItemPed\b0\fs20\highlight0 \cf2 \cf2  FROM\cf0 \cf0  tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd),0)  \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par\cf2 \cf2  IF\cf0 \cf0  @xped > 0\cf3 \cf3  AND\cf0 \cf0  @nitemped = 0  \par\cf2 \cf2  BEGIN\cf0 \cf0   \par   \cf2 \cf2  SET\cf0 \cf0  @nitemped =\cf3 \cf3  ISNULL\cf0 \cf0 (\cf2 \cf2 (SELECT\cf0 \cf0  MAX\cf3 \cf3 (ISNULL\cf0 \cf0 (\highlight5\fs24\b prod_nItemPed\b0\fs20\highlight0 ,0) + 1)\cf2 \cf2  FROM\cf0 \cf0  tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_xped = @xped\cf3 \cf3  AND\cf0 \cf0  prod_idMov = @idMov),1)  \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par   \par \cf4--VERIFICAR SE A CONFIGURACAO DA LOJA QUER VERIFIQUE SE O PRODUTO J\'c1 EST\'c1 NA LISTA \cf0  \par \cf4--LUIS 12/08/2015 \cf0  \par\cf2  IF\cf0 \cf3 \cf3  ISNULL\cf0 \cf0 (dbo.[fc_retLojaConfig] (@idLoja, 123), 0) > 0\cf3 \cf3  AND\cf0 \cf0  @idProd\cf3 \cf3  IS\cf0 \cf0  Null  \par\cf2 \cf2  BEGIN\cf0 \cf0   \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigoidProd\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0   \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigovOrig\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10)  \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigoqCom\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (16,4)  \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigovProd\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2)   \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigovFrete\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2)  \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigovDesc\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2)  \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigovSeg\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2)  \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigovOutro\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2)  \par \cf2 \cf2  DECLARE\cf0 \cf0  @AntigoInfAdic\cf2 \cf2  NVARCHAR\cf0 \cf0 (500)  \par   \par \cf2  SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1   \par     @AntigoidProd   = prod_idProd  \par     ,@AntigovOrig    =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_vorig, 0)  \par     ,@AntigoqCom    =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_qCom, 0)  \par     ,@AntigovProd    =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_vProd, 0)  \par     ,@AntigovFrete   =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_vFrete, 0)  \par     ,@AntigovDesc    =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_vDesc, 0)  \par     ,@AntigovSeg    =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_vSeg, 0)  \par     ,@AntigovOutro   =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_vOutro, 0)     \par     ,@AntigoInfAdic =\cf3 \cf3  ISNULL\cf0 \cf0 (prod_infAdProd, \cf1 '' \cf0 )  \par \cf2 \cf2  FROM\cf0 \cf0  tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idProduto = @idProduto\cf3 \cf3  AND\cf0 \cf0  prod_idMov = @idMov\cf3 \cf3  AND\cf0 \cf0  prod_indStatus = 0  \par   \par     \cf4--encontrou o item \cf0  \par    \cf2 \cf2  IF\cf0 \cf0  @AntigoidProd\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NOT\cf0 \cf0 \cf3  NULL\cf0 \cf3 \cf3  AND\cf0 \cf0  @AntigoqCom > 0  \par    \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2 \cf2  SET\cf0 \cf0  @idProd = @AntigoidProd  \par      \cf2 \cf2  SET\cf0 \cf0  @qCom = @AntigoqCom + @qCom  \par      \cf2 \cf2  SET\cf0 \cf0  @vProd = @AntigovProd + @vProd  \par      \cf2 \cf2  SET\cf0 \cf0  @vFrete = @AntigovFrete + @vFrete  \par      \cf2 \cf2  SET\cf0 \cf0  @vDesc = @AntigovDesc + @vDesc  \par      \cf2 \cf2  SET\cf0 \cf0  @vSeg = @AntigovSeg + @vSeg  \par      \cf2 \cf2  SET\cf0 \cf0  @vOutro = @AntigovOutro + @vOutro  \par      \cf2 \cf2  SET\cf0 \cf0  @infAdic = @AntigoInfAdic + @infAdic  \par    \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \par\cf2 \cf2  DECLARE\cf0 \cf0  @vNF\cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (15,2)  \par\cf2 \cf2  SET\cf0 \cf0  @vNF = \cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 tot_vNF\cf2 \cf2  FROM\cf0 \cf0  tbMovTotal\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  tot_idMov = @idMov)  \par \cf4/**********PROD DADOS ****/\cf0 */  \par\cf2 \cf2  IF\cf0 \cf0 \cf3  NOT\cf0 \cf3 \cf3  EXISTS\cf0 \cf0 \cf2 \cf2 (SELECT\cf0 \cf0  prod_idProd\cf2 \cf2  FROM\cf0 \cf0  tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd)  \par\cf2 \cf2  BEGIN\cf0 \cf0  \cf4--PROD DADOS INSERIR \cf0  \par    \cf4-- CRIA UM CAMPO   GUIX   PARA O NOVO PRODUTO \cf0  \par   \cf2 \cf2  SET\cf0 \cf0  @idProd = NEWID()  \par      \par   \cf2 \cf2  INSERT\cf0 \cf0 \cf2 \cf2  INTO\cf0 \cf0  [dbo].[tbMovProd]  \par            ([prod_idProd]  \par            ,[prod_idMov]  \par            ,[prod_idProduto]  \par            ,[prod_idOperador]  \par          ,[prod_idVendedor]  \par          ,[prod_idCfop]  \par            ,[prod_idTabPreco]  \par            ,[prod_tpProduto]  \par            ,[prod_nItem]  \par            ,[prod_cProd]  \par            ,[prod_cEan]  \par            ,[prod_xProd]  \par            ,[prod_ncm]  \par          ,[prod_cest]  \par            ,[prod_Nve]  \par            ,[prod_ExTipi]  \par            ,[prod_Cfop]  \par          , prod_vOrig  \par            ,[prod_uCom]  \par            ,[prod_qCom]  \par          ,prod_fator \cf4--Fator de convesao da qtd \cf0  \par            ,[prod_vUnCom]  \par            ,[prod_vProd]  \par            ,[prod_cEanTrib]  \par            ,[prod_uTrib]  \par            ,[prod_qTrib]  \par            ,[prod_vUnTrib]  \par            ,[prod_vFrete]  \par            ,[prod_vSeg]  \par            ,[prod_vDesc]  \par            ,[prod_vOutro]  \par            ,[prod_indTot]  \par            ,[prod_indStatus]  \par            ,[prod_indFin]  \par            ,[prod_indAtvCompra]  \par            ,[prod_vCusto]  \par            ,[prod_vRatDesc]  \par            ,[prod_vRatAcr]  \par            ,[prod_pTotTrib]  \par            ,[prod_ecfAliq]  \par            ,[prod_ecfIndice]  \par            ,[prod_xPed]  \par            ,[\highlight5\fs24\b prod_nItemPed\b0\fs20\highlight0 ]  \par            ,[prod_cBenef]  \par            ,[prod_nFci]  \par            ,[prod_pIpiDevol]  \par            ,[prod_vIpiDevol]  \par            ,[prod_infAdProd]  \par          ,[prod_indAtCom] \cf4--se a comissao foi atualizada \cf0  \par            ,[sys_idInsert]  \par            ,[sys_idUpdate]  \par            ,[sys_dInsert]  \par            ,[sys_dUpdate])  \par\cf2 \cf2  SELECT\cf0 \cf0   \par    @idProd  \par    ,@idMov  \par    ,pd.pro_idProduto  \par    , @idOperador     \par    , @idVendedor  \par    , @idCFOP  \par    , @idTabPreco  \par    , 0  \par    \cf3 \cf3 ,ISNULL\cf0 \cf0 ((Select max(prod_nItem) + 1 From tbMovProd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  prod_idMov = @idMov), 1)\cf2 \cf2  AS\cf0 \cf0  nItem-- NITEM  \par    \cf3 \cf3 ,ISNULL\cf0 \cf0 (@cProd, @idProd)\cf2 \cf2  AS\cf0 \cf0  cProd \cf4-- CODIGO DO PRODUTO \cf0  \par    \cf3 \cf3 ,ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 pro_codProduto\cf2 \cf2  FROM\cf0 \cf0  (\cf2 \cf2  SELECT\cf0 \cf0  pc.pro_codProduto,\cf2 \cf2 \cf2 (CASE\cf0 \cf0 \cf0 \cf2 \cf2  WHEN\cf0 \cf0  @cProd = pc.pro_codProduto\cf2 \cf2  THEN\cf0 \cf0  1\cf2 \cf2  ELSE\cf0 \cf0  0\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0 )\cf2 \cf2  AS\cf0 \cf0  pro_preferencia\cf2 \cf2  FROM\cf0 \cf0  tbProdutoCodigos pc\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoTpCodigos pt\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pc.pro_idTpCodigo = pt.pro_idTpCodigo\cf3 \cf3  AND\cf0 \cf0  pc.pro_indStatus = 0\cf2 \cf2  WHERE\cf0 \cf0  pt.pro_ean = 1\cf3 \cf3  AND\cf0 \cf0  pc.pro_idProduto = pd.pro_idProduto )\cf2 \cf2  AS\cf0 \cf0  TbProd\cf2  ORDER\cf0 \cf2 \cf2  BY\cf0 \cf0  pro_preferencia\cf2 \cf2  DESC\cf0 \cf0  ), \cf1 '' \cf0 )\cf2 \cf2  AS\cf0 \cf0  cEan \cf4--CEAN \cf0  \par    \cf3 \cf3 ,ISNULL\cf0 \cf0 (@xProd,\cf3 \cf3  LEFT\cf0 \cf0 (pd.pro_descProduto, 120))\cf2 \cf2  AS\cf0 \cf0  xProd \cf4-- XPROD \cf0  \par    ,pn.pro_codigo\cf2 \cf2  AS\cf0 \cf0  ncm-- NCM  \par    ,pn.pro_cest\cf2 \cf2  AS\cf0 \cf0  cest \cf4--novo codigo \cf0  \par    ,\cf1 '' \cf0 \cf2 \cf2  AS\cf0 \cf0  nve-- CODIGO NVE  \par    ,\cf1 '' \cf0 \cf2 \cf2  AS\cf0 \cf0  exTipi-- EXTIPI  \par    , @CFOP\cf2 \cf2  AS\cf0 \cf0  idCfop  \par    , @vOrig \cf4-- VALOR ORIGINAL DO PRODUTO \cf0  \par    ,\cf3 \cf3  LEFT\cf0 \cf0 (pm.pro_medida, 6)\cf2 \cf2  AS\cf0 \cf0  unCom \cf4-- UNCOMERCIAL \cf0  \par    , @qCom\cf2 \cf2  AS\cf0 \cf0  qCom  \par    ,1 \cf4-- fator padr\'e3o para conversao de quantidade \cf0  \par    ,\cf6 \cf6  IIF\cf0 \cf0 (ROUND(@vOrig * @qCom,2) = @vProd,  \par       @vOrig,  \par      \cf6 \cf6  IIF\cf0 \cf0 (ROUND((@vProd / @qCom),@cfgCasasValor) * @qCom = @vProd,   \par          ROUND((@vProd / @qCom),@cfgCasasValor),  \par         \cf6 \cf6  CAST\cf0 \cf0 ((@vProd / @qCom)\cf2  AS\cf0 \cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10))  \par          )  \par       )  \par    \cf2 \cf2  AS\cf0 \cf0  vUnCom \cf4-- vUnCom \cf0  \par    , @vProd\cf2 \cf2  AS\cf0 \cf0  vProd  \par    \cf3 \cf3 ,ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 pro_codProduto\cf2 \cf2  FROM\cf0 \cf0  (\cf2 \cf2  SELECT\cf0 \cf0  pc.pro_codProduto,\cf2 \cf2 \cf2 (CASE\cf0 \cf0 \cf0 \cf2 \cf2  WHEN\cf0 \cf0  @cProd = pc.pro_codProduto\cf2 \cf2  THEN\cf0 \cf0  1\cf2 \cf2  ELSE\cf0 \cf0  0\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0 )\cf2 \cf2  AS\cf0 \cf0  pro_preferencia\cf2 \cf2  FROM\cf0 \cf0  tbProdutoCodigos pc\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoTpCodigos pt\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pc.pro_idTpCodigo = pt.pro_idTpCodigo\cf3 \cf3  AND\cf0 \cf0  pc.pro_indStatus = 0\cf2 \cf2  WHERE\cf0 \cf0  pt.pro_ean = 1\cf3 \cf3  AND\cf0 \cf0  pc.pro_idProduto = pd.pro_idProduto  )\cf2 \cf2  AS\cf0 \cf0  TbProd\cf2  ORDER\cf0 \cf2 \cf2  BY\cf0 \cf0  pro_preferencia\cf2 \cf2  DESC\cf0 \cf0  ), \cf1 '' \cf0 )\cf2 \cf2  AS\cf0 \cf0  cEanTrib \cf4--CEANTRIB \cf0  \par    ,\cf3 \cf3  LEFT\cf0 \cf0 (pm.pro_medida, 6)\cf2 \cf2  AS\cf0 \cf0  unTrib \cf4-- UNTRIB \cf0  \par    , @qCom\cf2 \cf2  AS\cf0 \cf0  qTrib \cf4-- QTRIB \cf0  \par    , \cf6 \cf6  IIF\cf0 \cf0 (ROUND(@vOrig * @qCom,2) = @vProd,  \par       @vOrig,  \par      \cf6 \cf6  IIF\cf0 \cf0 (ROUND((@vProd / @qCom),@cfgCasasValor) * @qCom = @vProd,   \par          ROUND((@vProd / @qCom),@cfgCasasValor),  \par         \cf6 \cf6  CAST\cf0 \cf0 ((@vProd / @qCom)\cf2  AS\cf0 \cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10))  \par          )  \par       )\cf2 \cf2  AS\cf0 \cf0  vUnTrib \cf4-- vUnTRIB \cf0  \par    , @vFrete\cf2 \cf2  AS\cf0 \cf0  vFrete  \par    , @vSeg\cf2 \cf2  AS\cf0 \cf0  vSeg  \par    , @vDesc\cf2 \cf2  AS\cf0 \cf0  vDEsc  \par    , @vOutro\cf2 \cf2  AS\cf0 \cf0  vOutro  \par    , @indTot\cf2 \cf2  AS\cf0 \cf0  indTot \cf4-- INDICA QUE O ITEM PARTICIPA DO TOTAL DA NOTA \cf0  \par    , 0\cf2 \cf2  AS\cf0 \cf0  indStatus  \par    , 1\cf2 \cf2  AS\cf0 \cf0  indFin  \par    , 1\cf2 \cf2  AS\cf0 \cf0  indAtvCompra  \par    , [dbo].[fc_retProdvCusto](pd.pro_idProduto, @idLoja,\cf3 \cf3  NULL\cf0 \cf0 )\cf2 \cf2  AS\cf0 \cf0  vCusto \cf4-- VCUSTO \cf0  \par    , 0\cf2 \cf2  AS\cf0 \cf0  vRatDesc-- vRatDesc  \par    , 0\cf2 \cf2  AS\cf0 \cf0  vRetAcresc \cf4-- vRatAcresc \cf0  \par    ,--/************ PTOT TRIB *********/  \par      \cf2 \cf2 \cf2  CASE\cf0 \cf0 \cf0   \par         \cf2 \cf2  WHEN\cf0 \cf0   pd.pro_origem\cf3 \cf3  IN\cf0 \cf0  (1,2,6,7)\cf2 \cf2  THEN\cf0 \cf0   \par            \cf3 \cf3  ISNULL\cf0 \cf0 (pn.pro_pTribImp,0)  \par         \cf2 \cf2  ELSE\cf0 \cf0   \par            \cf3 \cf3  ISNULL\cf0 \cf0 (pn.pro_pTribNac,0)  \par      \cf2 \cf2  END\cf0 \cf0 \cf2 \cf2  AS\cf0 \cf0  pTotTrib  \par         \par    , 0\cf2 \cf2  AS\cf0 \cf0  ecfAliq--/ *********** ECF ALIQ *********/  \par    , 0\cf2 \cf2  AS\cf0 \cf0  ecfInd--/************ INDICE ECF ******/  \par    , @xped \cf4-- xped \cf0  \par    , @nitemped \cf4--nitemped \cf0  \par    , @cBenef \cf4-- xped \cf0  \par    , \cf1 '' \cf0 \cf2 \cf2  AS\cf0 \cf0  fci \cf4--FCI \cf0  \par    , 0\cf2 \cf2  AS\cf0 \cf0  vipiDev-- VALOR IPI DEVOLVIDO  \par    , 0\cf2 \cf2  AS\cf0 \cf0  pipiDev-- PERCENTUAL DO IPI DEVOLVIDO  \par    , @infAdic  \par    , 0 \cf4-- se a comissao foi gerada \cf0  \par    , @idUsuario  \par    , @idUsuario  \par    , dbo.getDateSaurus()  \par    , dbo.getDateSaurus()  \par\cf2 \cf2  FROM\cf0 \cf0   \par    tbProdutoDados pd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoNcms pn\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par   \cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pd.pro_idNcm = pn.pro_idNcm  \par    \cf4---MEDIDA \cf0  \par   \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoMedidas pm\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par   \cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pm.pro_idMedida = pd.pro_idMedida  \par\cf2 \cf2  WHERE\cf0 \cf0  pd.pro_idProduto = @idProduto  \par   \par   \par\cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(10, \cf1 '' \cf0 , 0) \cf4--inserido \cf0  \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par\cf2 \cf2  ELSE\cf0 \cf0   \par\cf2 \cf2  BEGIN\cf0 \cf0   \par      \par   \cf2 \cf2  UPDATE\cf0 \cf0  [dbo].[tbMovProd]\cf2 \cf2  SET\cf0 \cf0    \par          [prod_idProduto] = tab.pro_idProduto  \par         ,[prod_idOperador] = @idOperador  \par         ,prod_idVendedor = @idVendedor   \par         ,prod_idCfop = @idCFOP  \par         ,prod_idTabPreco = @idTabPreco  \par         ,[prod_cProd] = tab.cProd  \par         ,[prod_cEan] = tab.cEan  \par         ,[prod_xProd] = @xProd  \par         ,[prod_ncm] = tab.ncm  \par         ,[prod_cest] = tab.cest  \par         ,[prod_Nve] = tab.nve  \par         ,[prod_ExTipi] = tab.exTipi  \par         ,[prod_Cfop] = @CFOP  \par         ,[prod_uCom] = tab.unCom  \par         ,[prod_qCom] = @qCom  \par         ,[prod_vUnCom] = \cf6 \cf6  IIF\cf0 \cf0 (ROUND(@vOrig * @qCom,2) = @vProd,  \par                         @vOrig,  \par                        \cf6 \cf6  IIF\cf0 \cf0 (ROUND((@vProd / @qCom),@cfgCasasValor) * @qCom = @vProd,   \par                            ROUND((@vProd / @qCom),@cfgCasasValor),  \par                           \cf6 \cf6  CAST\cf0 \cf0 ((@vProd / @qCom)\cf2  AS\cf0 \cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10))  \par                            )  \par                         )  \par         ,[prod_vProd] =  @vProd  \par         ,[prod_cEanTrib] = tab.cEanTrib  \par         ,[prod_uTrib] = tab.unTrib  \par         ,[prod_qTrib] = @qCom  \par         ,[prod_vUnTrib] =\cf6 \cf6  IIF\cf0 \cf0 (ROUND(@vOrig * @qCom,2) = @vProd,  \par                         @vOrig,  \par                        \cf6 \cf6  IIF\cf0 \cf0 (ROUND((@vProd / @qCom),@cfgCasasValor) * @qCom = @vProd,   \par                            ROUND((@vProd / @qCom),@cfgCasasValor),  \par                           \cf6 \cf6  CAST\cf0 \cf0 ((@vProd / @qCom)\cf2  AS\cf0 \cf2 \cf2 \cf2  DECIMAL\cf0 \cf0 \cf0 (21,10))  \par                            )  \par                         )  \par         ,[prod_vFrete] = @vFrete  \par         ,[prod_vSeg] = @vSeg  \par         ,[prod_vDesc] = @vDesc  \par         ,[prod_vOutro] = @vOutro  \par         ,[prod_indTot] = @indTot  \par         ,[prod_vCusto] = tab.vCusto  \par         ,[prod_pTotTrib] = tab.pTotTrib  \par         ,[prod_ecfAliq] = 0   \par         ,[prod_ecfIndice] = 0  \par         ,[prod_xPed] = @xped  \par         ,[\highlight5\fs24\b prod_nItemPed\b0\fs20\highlight0 ] = @nitemped  \par         ,[prod_cBenef] = @cBenef  \par         ,[prod_nFci] = \cf1 '' \cf0   \par         ,[prod_vIpiDevol] = 0  \par         ,[prod_infAdProd] = @infAdic  \par         ,[sys_idUpdate] = @idUsuario  \par         ,[sys_dUpdate] = dbo.getDateSaurus()  \par         ,[prod_vOrig] = @vOrig  \par         ,[prod_pIpiDevol] = 0  \par   \cf2 \cf2  FROM\cf0 \cf0    \par    (  \par      \cf2 \cf2  SELECT\cf0 \cf0   \par             pd.pro_idProduto                       \par             \cf3 \cf3 ,ISNULL\cf0 \cf0 (@cProd, @idProd)\cf2 \cf2  AS\cf0 \cf0  cProd \cf4-- CODIGO DO PRODUTO \cf0  \par             \cf3 \cf3 ,ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 pro_codProduto\cf2 \cf2  FROM\cf0 \cf0  (\cf2 \cf2  SELECT\cf0 \cf0      pc.pro_codProduto,\cf2 \cf2 \cf2 (CASE\cf0 \cf0 \cf0 \cf2 \cf2  WHEN\cf0 \cf0  @cProd = pc.pro_codProduto\cf2 \cf2  THEN\cf0 \cf0  1\cf2 \cf2  ELSE\cf0 \cf0  0\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0 )\cf2 \cf2  AS\cf0 \cf0  pro_preferencia\cf2 \cf2  FROM\cf0 \cf0  tbProdutoCodigos pc\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoTpCodigos pt\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pc.pro_idTpCodigo = pt.pro_idTpCodigo\cf3 \cf3  AND\cf0 \cf0  pc.pro_indStatus = 0\cf2 \cf2  WHERE\cf0 \cf0  pt.pro_ean = 1\cf3 \cf3  AND\cf0 \cf0  pc.pro_idProduto = pd.pro_idProduto )\cf2 \cf2  AS\cf0 \cf0  TbProd\cf2  ORDER\cf0 \cf2 \cf2  BY\cf0 \cf0  pro_preferencia\cf2 \cf2  DESC\cf0 \cf0  ), \cf1 '' \cf0 )\cf2 \cf2  AS\cf0 \cf0  cEan \cf4--CEAN \cf0  \par             \cf3 \cf3 ,ISNULL\cf0 \cf0 (@xProd,\cf3 \cf3  LEFT\cf0 \cf0 (pd.pro_descProduto, 120))\cf2 \cf2  AS\cf0 \cf0  xProd \cf4-- XPROD \cf0  \par             ,pn.pro_codigo\cf2 \cf2  AS\cf0 \cf0  ncm-- NCM  \par             ,pn.pro_cest\cf2 \cf2  AS\cf0 \cf0  cest \cf4--cest \cf0  \par             ,\cf1 '' \cf0 \cf2 \cf2  AS\cf0 \cf0  nve-- CODIGO NVE  \par             ,\cf1 '' \cf0 \cf2 \cf2  AS\cf0 \cf0  exTipi-- EXTIPI        \par             ,\cf3 \cf3  LEFT\cf0 \cf0 (pm.pro_medida, 6)\cf2 \cf2  AS\cf0 \cf0  unCom \cf4-- UNCOMERCIAL \cf0  \par            \par             \cf3 \cf3 ,ISNULL\cf0 \cf0 (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 pro_codProduto\cf2 \cf2  FROM\cf0 \cf0  (\cf2 \cf2  SELECT\cf0 \cf0  pc.pro_codProduto,\cf2 \cf2 \cf2 (CASE\cf0 \cf0 \cf0 \cf2 \cf2  WHEN\cf0 \cf0  @cProd = pc.pro_codProduto\cf2 \cf2  THEN\cf0 \cf0  1\cf2 \cf2  ELSE\cf0 \cf0  0\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0 )\cf2 \cf2  AS\cf0 \cf0  pro_preferencia\cf2 \cf2  FROM\cf0 \cf0  tbProdutoCodigos pc\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoTpCodigos pt\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pc.pro_idTpCodigo = pt.pro_idTpCodigo\cf3 \cf3  AND\cf0 \cf0  pc.pro_indStatus = 0\cf2 \cf2  WHERE\cf0 \cf0  pt.pro_ean = 1\cf3 \cf3  AND\cf0 \cf0  pc.pro_idProduto = pd.pro_idProduto  )\cf2 \cf2  AS\cf0 \cf0  TbProd\cf2  ORDER\cf0 \cf2 \cf2  BY\cf0 \cf0  pro_preferencia\cf2 \cf2  DESC\cf0 \cf0  ), \cf1 '' \cf0 )\cf2 \cf2  AS\cf0 \cf0  cEanTrib \cf4--CEANTRIB \cf0  \par             ,\cf3 \cf3  LEFT\cf0 \cf0 (pm.pro_medida, 6)\cf2 \cf2  AS\cf0 \cf0  unTrib \cf4-- UNTRIB \cf0                    \par             , [dbo].[fc_retProdvCusto](pd.pro_idProduto, @idLoja,\cf3 \cf3  NULL\cf0 \cf0 )\cf2 \cf2  AS\cf0 \cf0  vCusto \cf4-- VCUSTO \cf0  \par             ,--/************ PTOT TRIB *********/  \par               \cf2 \cf2 \cf2  CASE\cf0 \cf0 \cf0   \par                  \cf2 \cf2  WHEN\cf0 \cf0   pd.pro_origem\cf3 \cf3  IN\cf0 \cf0  (1,2,6,7)\cf2 \cf2  THEN\cf0 \cf0   \par                     \cf3 \cf3  ISNULL\cf0 \cf0 (pn.pro_pTribImp,0)  \par                  \cf2 \cf2  ELSE\cf0 \cf0   \par                     \cf3 \cf3  ISNULL\cf0 \cf0 (pn.pro_pTribNac,0)  \par               \cf2 \cf2  END\cf0 \cf0 \cf2 \cf2  AS\cf0 \cf0  pTotTrib        \par         \cf2 \cf2  FROM\cf0 \cf0   \par             tbProdutoDados pd\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoNcms pn\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par            \cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pd.pro_idNcm = pn.pro_idNcm  \par             \cf4---MEDIDA \cf0  \par            \cf3 \cf3  INNER\cf0 \cf0 \cf3 \cf3  JOIN\cf0 \cf0  tbProdutoMedidas pm\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )  \par            \cf2 \cf2 \cf2  ON\cf0 \cf0 \cf0  pm.pro_idMedida = pd.pro_idMedida  \par         \cf2 \cf2  WHERE\cf0 \cf0  pd.pro_idProduto = @idProduto  \par    ) \cf2 \cf2  AS\cf0 \cf0  tab  \par    \cf2 \cf2  WHERE\cf0 \cf0  prod_idProd = @idProd  \par   \par\cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr(11, \cf1 '' \cf0 , 0) \cf4-- atualizado \cf0  \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par \cf4/****** COMBUST\'cdVEIS *****/\cf0 */  \par\cf2 \cf2  DECLARE\cf0 \cf0  @retIdComb\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0   \par\cf2 \cf2  DECLARE\cf0 \cf0  @retComb  \cf2 \cf2  NVARCHAR\cf0 \cf0 (MAX)  \par\cf2 \cf2  EXECUTE\cf0 \cf0  [dbo].[sp_tbMovProdComb]  \par     \cf1 'S' \cf0   \par    ,@idProd  \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    \cf3 \cf3 ,NULL\cf0 \cf0   \par    ,@idUsuario  \par    ,@idLojaMaster  \par    ,@retComb\cf2 \cf2  OUTPUT\cf0 \cf0   \par    ,@retIdComb\cf2 \cf2  OUTPUT\cf0 \cf0   \par\cf2 \cf2  IF\cf0 \cf0  @retIdComb\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NULL\cf0 \cf0   \par   \cf2 \cf2  THROW\cf0 \cf0  50009, @retComb, 1  \par   \par \cf4--CALCULAR IMPOSTOS \cf0  \par\cf2 \cf2  DECLARE\cf0 \cf0  @RC\cf2 \cf2 \cf2  INT\cf0 \cf0 \cf0   \par\cf2 \cf2  DECLARE\cf0 \cf0  @imp_retid\cf2 \cf2  UNIQUEIDENTIFIER\cf0 \cf0   \par\cf2 \cf2  DECLARE\cf0 \cf0  @imp_ret\cf2 \cf2  NVARCHAR\cf0 \cf0 (4000)  \par\cf2 \cf2  EXECUTE\cf0 \cf0  @RC = [dbo].[sp_tbMovProdImpostos]   \par    @idProd  \par   ,@imp_retid\cf2 \cf2  OUTPUT\cf0 \cf0   \par   ,@imp_ret\cf2 \cf2  OUTPUT\cf0 \cf0   \par   \par   \cf2 \cf2  IF\cf0 \cf0  @imp_retid\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NULL\cf0 \cf0   \par      \cf2 \cf2  THROW\cf0 \cf0  50009, @imp_ret, 1  \par      \par    \cf4--CALCULA O TOTAL DA MOV \cf0   \par    \cf4--ESTOU TRAZENDO ELE ANTES DO   IF   DE ALTERA\'c7\'c3O PARA COMPARARMOS O TOTAL ATUAL COM O TOTAL ANTERIOR \cf0  \par   \cf2 \cf2  EXEC\cf0 \cf0  sp_evMovTotal @idMov  \par   \par         \cf4--REDEFINO PARA CALCULAR SE HOUVE ALTERA\'c7\'c3O \cf0  \par    \cf4--SET @alterouFatura = 0 \cf0  \par       \cf4-- REFOR\'c7O AQUI PARA CONFIRMAR QUE N\'c3O EXISTE PRODUTO NA FATURAPRODS COM ESSE ITEM \cf0  \par       \cf4-- SE N\'c3O EXISTE, O PRODUTO \'c9 NOVO \cf0  \par       \cf4-- SE \'c9 NOVO, ESTAMOS ALTERANDO O PEDIDO E POR ISSO O FATURAMENTO \'c9 RESETADO. \cf0  \par   \cf2 \cf2  IF\cf0 \cf0  (\cf2 (SELECT\cf0 \cf2 \cf2  TOP\cf0 \cf0  1 tot_vNF\cf2 \cf2  FROM\cf0 \cf0  tbMovTotal\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 )\cf2 \cf2  WHERE\cf0 \cf0  tot_idMov = @idMov) <> @vNF)  \par   \cf2 \cf2  BEGIN\cf0 \cf0   \par      \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovFaturaPags\cf2 \cf2  WHERE\cf0 \cf0  fat_idFatura\cf3 \cf3  IN\cf0 \cf0  (select fat_idFatura\cf2 \cf2  FROM\cf0 \cf0  tbMovFaturas\cf2 \cf2  WITH\cf0 \cf0  \cf2 \cf2 (NOLOCK\cf0 \cf0 ) \cf2 \cf2  WHERE\cf0 \cf0  fat_idMov = @idMov)  \par      \cf2  DELETE\cf0 \cf2 \cf2  FROM\cf0 \cf0  tbMovFaturas\cf2 \cf2  WHERE\cf0 \cf0  fat_idMov = @idMov  \par      \cf2 \cf2  SET\cf0 \cf0  @ret = @ret + \cf1 '. Obs: Necess\'e1rio refazer o faturamento.' \cf0   \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \cf2 \cf2  IF\cf0 \cf0  @indTransacaoLocal = 1\cf3 \cf3  AND\cf0 \cf0 \cf6 \cf6  @@TRANCOUNT\cf0 \cf0  > 0\cf2  COMMIT\cf0 \cf2 \cf2  TRAN\cf0 \cf0   \par   \par   \cf2 \cf2  SET\cf0 \cf0  @retid =  @idProd  \par      \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0 \cf2 \cf2  TRY\cf0 \cf0   \par   \par\cf2 \cf2  BEGIN\cf0 \cf0 \cf2 \cf2  CATCH\cf0 \cf0   \par      \par   \cf2 \cf2  SET\cf0 \cf0  @retid =\cf3 \cf3  NULL\cf0 \cf0   \par   \cf2 \cf2  IF\cf0 \cf0  (@imp_retid\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NULL\cf0 \cf0 \cf3 \cf3  OR\cf0 \cf0  @retIdComb\cf3  IS\cf0 \cf3 \cf3  NULL\cf0 \cf0 )\cf3 \cf3  AND\cf0 \cf0  @retid\cf3 \cf3  IS\cf0 \cf0 \cf3 \cf3  NOT\cf0 \cf0 \cf3 \cf3  NULL\cf0 \cf0    \par      \cf2 \cf2  SET\cf0 \cf0  @ret =\cf3 \cf3  ISNULL\cf0 \cf0 (@imp_ret, @retComb)  \par   \cf2 \cf2  ELSE\cf0 \cf0      \par      \cf2 \cf2  SET\cf0 \cf0  @ret = dbo.fc_cfgRetErr\cf6 \cf6 (ERROR_NUMBER\cf0 \cf0 (),\cf6 \cf6  ERROR_MESSAGE\cf0 \cf0 (), 1)  \par   \par   \cf2 \cf2  IF\cf0 \cf0 \cf6 \cf6  @@TRANCOUNT\cf0 \cf0  > 0  \par   \cf2 \cf2  BEGIN\cf0 \cf0    \par      \cf2  IF\cf0 \cf3 \cf3  ISNULL\cf0 \cf0 (@indTransacaoLocal, 0) = 1   \par         \cf2 \cf2  ROLLBACK\cf0 \cf0 \cf2 \cf2  TRAN\cf0 \cf0   \par      \cf2 \cf2  ELSE\cf0 \cf0   \par         \cf2 \cf2  THROW\cf0 \cf0  50009, @ret, 1;  \par   \cf2 \cf2 \cf2  END\cf0 \cf0 \cf0   \par   \par   \cf2 \cf2  RETURN\cf0 \cf0   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0 \cf2 \cf2  CATCH\cf0 \cf0   \par\cf2 \cf2 \cf2  END\cf0 \cf0 \cf0  \par}

